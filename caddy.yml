---
# caddy.yml — Provision and configure Caddy reverse proxy LXC on PVE01
#
# Prerequisites:
#   - 1Password CLI (op) v2+ signed in on the controller
#   - community.general collection installed
#   - Unifi DHCP reservation for caddy (MAC will be assigned at first boot)
#
# Usage:
#   ansible-playbook caddy.yml
#   ansible-playbook caddy.yml --tags template     # Only build the LXC template
#   ansible-playbook caddy.yml --tags provision     # Only create the LXC
#   ansible-playbook caddy.yml --tags configure     # Only configure Caddy

# ── Phase 0: Ensure Trixie LXC template exists ─────────────────
- name: Build Debian 13 Trixie LXC template if missing
  hosts: pve01
  become: true
  gather_facts: false
  tags: [template, provision]

  vars:
    dab_work_dir: "/root/dab/debian-13-standard"
    dab_git_base: "https://git.proxmox.com/?p=dab-pve-appliances.git;a=blob_plain;hb=HEAD;f=debian-13-trixie-std-64"
    template_cache_dir: "/var/lib/vz/template/cache"

  tasks:
    - name: Check if Trixie template already exists
      ansible.builtin.find:
        paths: "{{ template_cache_dir }}"
        patterns: "debian-13-standard_*.tar.*"
      register: trixie_template

    - name: Build Trixie template with dab
      when: trixie_template.matched == 0
      block:
        - name: Install dab
          ansible.builtin.apt:
            name: dab
            state: present
            update_cache: true

        - name: Create dab working directory
          ansible.builtin.file:
            path: "{{ dab_work_dir }}"
            state: directory
            mode: "0755"

        - name: Download dab.conf
          ansible.builtin.get_url:
            url: "{{ dab_git_base }}/dab.conf"
            dest: "{{ dab_work_dir }}/dab.conf"
            mode: "0644"

        - name: Download Makefile
          ansible.builtin.get_url:
            url: "{{ dab_git_base }}/Makefile"
            dest: "{{ dab_work_dir }}/Makefile"
            mode: "0644"

        - name: Build template (this takes a few minutes)
          ansible.builtin.command:
            cmd: make
            chdir: "{{ dab_work_dir }}"
          register: dab_build
          changed_when: dab_build.rc == 0

        - name: Copy template to cache
          ansible.builtin.copy:
            src: "{{ item.path }}"
            dest: "{{ template_cache_dir }}/"
            remote_src: true
            mode: "0644"
          with_fileglob:
            - "{{ dab_work_dir }}/debian-13-standard_*.tar.*"

    - name: Detect template filename
      ansible.builtin.find:
        paths: "{{ template_cache_dir }}"
        patterns: "debian-13-standard_*.tar.*"
      register: trixie_template_final

    - name: Set template fact for provisioning
      ansible.builtin.set_fact:
        caddy_lxc_template_resolved: "local:vztmpl/{{ trixie_template_final.files[0].path | basename }}"
      when: trixie_template_final.matched > 0

# ── Phase 1: Provision LXC container ───────────────────────────
- name: Provision Caddy LXC container on Proxmox
  hosts: localhost
  connection: local
  gather_facts: false
  tags: [provision]

  vars:
    proxmox_host: "pve01"
    proxmox_api_host: "{{ hostvars['pve01']['ansible_host'] }}"
    proxmox_api_user: "root@pam"
    # Template: use detected name from dab build, or fall back to host_vars default
    caddy_lxc_template_actual: >-
      {{ hostvars['pve01']['caddy_lxc_template_resolved']
         | default(caddy_lxc_template) }}

  tasks:
    - name: Create Caddy LXC container
      community.general.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_host }}"
        hostname: "caddy"
        vmid: 150
        ostemplate: "{{ caddy_lxc_template_actual }}"
        storage: "local-lvm"
        disk: "4"
        cores: 1
        memory: 256
        swap: 256
        nameserver: "{{ caddy_nameserver }}"
        searchdomain: "{{ caddy_search_domain }}"
        net:
          net0: "name=eth0,bridge=vmbr0,tag=50,ip=dhcp,firewall=1"
        pubkey: "{{ ops_ssh_public_key }}"
        onboot: true
        unprivileged: true
        features:
          - nesting=1
        state: present

    - name: Start Caddy LXC container
      community.general.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_host }}"
        vmid: 150
        state: started

    - name: Wait for container to get DHCP lease and become reachable
      ansible.builtin.wait_for:
        host: "{{ hostvars['caddy']['ansible_host'] }}"
        port: 22
        delay: 10
        timeout: 90

# ── Phase 2: Configure Caddy ───────────────────────────────────
- name: Configure Caddy reverse proxy
  hosts: caddy
  become: true
  gather_facts: true
  tags: [configure]

  roles:
    - role: caddy