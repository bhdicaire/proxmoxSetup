---
# caddy.yml — Provision and configure Caddy reverse proxy LXC on PVE-01
#
# Prerequisites:
#   - 1Password CLI (op) v2+ signed in on the controller
#   - community.general collection installed
#   - Unifi DHCP reservation for caddy on dProxy (VLAN 50)
#
# Usage:
#   ansible-playbook caddy.yml
#   ansible-playbook caddy.yml --tags template     # Only ensure LXC template
#   ansible-playbook caddy.yml --tags provision     # Only create the LXC
#   ansible-playbook caddy.yml --tags configure     # Only configure Caddy

# ── Phase 0: Ensure Trixie LXC template exists ─────────────────
- import_playbook: roles/common/tasks/ensureTemplate.yml

# ── Phase 1: Provision LXC container ───────────────────────────
- name: Provision Caddy LXC container on Proxmox
  hosts: pve-01
  become: true
  gather_facts: false
  tags: [provision]

  tasks:
    # ── Create container if it doesn't exist ─────────────────────
    - name: Check if container already exists
      ansible.builtin.command: "pct status 150"
      register: pct_status
      failed_when: false
      changed_when: false

    - name: Write ops public key for container injection
      ansible.builtin.copy:
        content: "{{ ops_ssh_public_key }}\n"
        dest: /tmp/ops_authorized_key
        mode: "0644"
      when: pct_status.rc != 0

    - name: Create Caddy LXC container
      ansible.builtin.command: >
        pct create 150 {{ pve_lxc_template_resolved }}
        --hostname caddy
        --cores 1
        --memory 512
        --swap 0
        --rootfs local-zfs:4
        --net0 name=eth0,bridge=vmbr0,tag=50,ip=dhcp,firewall=1
        --nameserver {{ hostvars['caddy']['caddy_nameserver'] }}
        --searchdomain {{ hostvars['caddy']['caddy_search_domain'] }}
        --ostype debian
        --unprivileged 1
        --features nesting=1
        --onboot 1
        --start 0
        --ssh-public-keys /tmp/ops_authorized_key
      when: pct_status.rc != 0

    - name: Remove temporary SSH key file
      ansible.builtin.file:
        path: /tmp/ops_authorized_key
        state: absent

    # ── Apply config updates (idempotent — runs every time) ──────
    - name: Update container configuration
      ansible.builtin.command: >
        pct set 150
        --cores 1
        --memory 512
        --swap 0
        --nameserver {{ hostvars['caddy']['caddy_nameserver'] }}
        --searchdomain {{ hostvars['caddy']['caddy_search_domain'] }}
        --onboot 1
      changed_when: false

    # ── Start container ──────────────────────────────────────────
    - name: Start Caddy container
      ansible.builtin.command: "pct start 150"
      register: pct_start
      failed_when: pct_start.rc != 0 and 'already running' not in pct_start.stderr
      changed_when: "'already running' not in pct_start.stderr"

    - name: Wait for container to be ready
      ansible.builtin.pause:
        seconds: 10

# ── Phase 2: Bootstrap ops user (via pct exec from PVE host) ───
- name: Bootstrap ops user in Caddy container
  hosts: pve-01
  become: true
  gather_facts: false
  tags: [provision]

  tasks:
    - name: Check if ops user already exists
      ansible.builtin.command: "pct exec 150 -- id ops"
      register: ops_check
      failed_when: false
      changed_when: false

    - name: Create ops user with sudo and SSH key
      ansible.builtin.shell: |
        pct exec 150 -- bash -c '
          apt-get update -qq
          apt-get install -y -qq sudo openssh-server > /dev/null
          useradd -m -s /bin/bash -G sudo ops
          echo "ops ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ops
          chmod 0440 /etc/sudoers.d/ops
          mkdir -p /home/ops/.ssh
          echo "{{ ops_ssh_public_key }}" > /home/ops/.ssh/authorized_keys
          chmod 700 /home/ops/.ssh
          chmod 600 /home/ops/.ssh/authorized_keys
          chown -R ops:ops /home/ops/.ssh
          systemctl enable --now ssh
        '
      when: ops_check.rc != 0

    # ── Get container IP for Phase 3 ─────────────────────────────
    - name: Wait for DHCP lease
      ansible.builtin.shell: |
        for i in $(seq 1 30); do
          IP=$(pct exec 150 -- ip -4 addr show eth0 2>/dev/null | grep -oP 'inet \K[\d.]+')
          if [ -n "$IP" ]; then
            echo "$IP"
            exit 0
          fi
          sleep 2
        done
        exit 1
      register: container_ip
      changed_when: false

    - name: Display Caddy container IP
      ansible.builtin.debug:
        msg: "Caddy container IP: {{ container_ip.stdout | trim }}"

#     - name: Wait for SSH to be reachable
#       ansible.builtin.wait_for:
#         host: "{{ hostvars['caddy']['ansible_host'] }}"
#         port: 22
#         delay: 5
#         timeout: 90

# ── Phase 3: Configure Caddy (connects via SSH as ops) ─────────
- name: Configure Caddy reverse proxy
  hosts: caddy
  become: true
  gather_facts: true
  tags: [configure]

  roles:
    - role: common
    - role: caddy