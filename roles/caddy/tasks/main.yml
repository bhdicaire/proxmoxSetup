---
# ── ops user setup ──────────────────────────────────────────────

- name: Create ops user
  ansible.builtin.user:
    name: "{{ caddy_ops_user }}"
    uid: "{{ caddy_ops_uid }}"
    shell: "{{ caddy_ops_shell }}"
    groups: ["sudo"]
    append: true
    create_home: true
    state: present

- name: Set up SSH authorized key for ops
  ansible.posix.authorized_key:
    user: "{{ caddy_ops_user }}"
    key: "{{ ops_ssh_public_key }}"
    state: present
    exclusive: false

- name: Allow ops passwordless sudo
  ansible.builtin.copy:
    content: "{{ caddy_ops_user }} ALL=(ALL) NOPASSWD:ALL\n"
    dest: "/etc/sudoers.d/{{ caddy_ops_user }}"
    mode: "0440"
    validate: "visudo -cf %s"

- name: Harden SSH — disable root login and password auth
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
  notify: Restart SSH

# ── Caddy installation ──────────────────────────────────────────

- name: Install prerequisites
  ansible.builtin.apt:
    name:
      - debian-keyring
      - debian-archive-keyring
      - apt-transport-https
      - curl
      - sudo
      - nfs-common
    state: present
    update_cache: true

- name: Add Caddy GPG key
  ansible.builtin.shell: |
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \
      gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  when: caddy_install_method == "repo"

- name: Add Caddy apt repository
  ansible.builtin.shell: |
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \
      tee /etc/apt/sources.list.d/caddy-stable.list
  args:
    creates: /etc/apt/sources.list.d/caddy-stable.list
  when: caddy_install_method == "repo"

- name: Install Caddy
  ansible.builtin.apt:
    name: caddy
    state: present
    update_cache: true
  when: caddy_install_method == "repo"

# ── Caddy configuration ────────────────────────────────────────

- name: Create log directory
  ansible.builtin.file:
    path: "{{ caddy_log_dir }}"
    state: directory
    owner: "{{ caddy_user }}"
    group: "{{ caddy_group }}"
    mode: "0750"

- name: Configure NAS mounts
  ansible.posix.mount:
    src: "{{ item.src }}"
    path: "{{ item.dest }}"
    fstype: "{{ item.fstype | default('nfs') }}"
    opts: "{{ item.opts | default('ro,soft,timeo=5') }}"
    state: mounted
  loop: "{{ caddy_nas_mounts }}"
  when: caddy_nas_mounts | length > 0

- name: Deploy Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ caddy_config_dir }}/Caddyfile"
    owner: root
    group: "{{ caddy_group }}"
    mode: "0644"
    validate: "caddy validate --config %s --adapter caddyfile"
  notify: Reload Caddy

- name: Ensure Caddy is enabled and running
  ansible.builtin.systemd:
    name: caddy
    enabled: true
    state: started