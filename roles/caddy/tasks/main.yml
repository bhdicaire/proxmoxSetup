
# Caddy (LXC): Receives traffic on port 80/443. It's the only container you need to port-forward from your router.
- name: Create Caddy LXC on Proxmox
  community.proxmox.proxmox:
    api_host: "{{ pve_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_password: "{{ pve_api_password }}"
    node: "{{ pve_node }}"
    vmid: 101
    hostname: "caddy-gateway"
    ostemplate: "local:vztmpl/debian-13-standard_amd64.tar.zst"
    net0: "name=eth0,bridge=vmbr0,ip=192.168.1.50/24,gw=192.168.1.1"
    state: started
  delegate_to: localhost

- name: Download Caddy with Cloudflare Plugin
  get_url:
    url: "https://caddyserver.com/api/download?os=linux&arch=amd64&p=github.com/caddy-dns/cloudflare"
    dest: /usr/bin/caddy
    mode: '0755'

- name: Ensure Caddy systemd override exists
  file:
    path: /etc/systemd/system/caddy.service.d
    state: directory

- name: Set Cloudflare Token in Environment
  copy:
    dest: /etc/systemd/system/caddy.service.d/override.conf
    content: |
      [Service]
      Environment="CLOUDFLARE_API_TOKEN={{ cloudflare_token }}"
  notify: Reload Caddy

- name: Deploy Dynamic Caddyfile
  template:
    src: Caddyfile.j2
    dest: /etc/caddy/Caddyfile
  notify: Reload Caddy

