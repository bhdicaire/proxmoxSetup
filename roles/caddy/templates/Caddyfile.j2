# Caddyfile â€” managed by Ansible
# Wildcard cert for *.{{ caddy_domain }} via Cloudflare DNS-01

{
    admin off
    email {{ caddy_acme_email }}
}

*.{{ caddy_domain }} {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }

{% for site in caddy_sites %}
    @{{ site.subdomain }} host {{ site.subdomain }}.{{ caddy_domain }}
    handle @{{ site.subdomain }} {
        reverse_proxy {{ site.upstream }} {
{% if site.tls_insecure | default(false) %}
            transport http {
                tls_insecure_skip_verify
            }
{% endif %}
        }
    }

{% endfor %}
    # Catch-all for unconfigured subdomains
    handle {
        respond "Service not configured" 404
    }

    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}
