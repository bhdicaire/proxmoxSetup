- name: Install NFS client and Calibre dependencies
  apt:
    name: [nfs-common, python3-venv, python3-pip, libgl1-mesa-glx, wget, xz-utils]
    state: present
    update_cache: yes

- name: Ensure mount point exists
  file:
    path: "{{ calibre_library_path }}"
    state: directory
    owner: "{{ calibre_web_user }}"
    mode: '0775'

- name: Mount NFS Library from Unifi uNAS
  ansible.posix.mount:
    src: "{{ nas_nfs_server }}:{{ nas_nfs_path }}"
    path: "{{ calibre_library_path }}"
    opts: "{{ nfs_mount_opts }}"
    state: mounted
    fstype: nfs

- name: Create empty Calibre DB if missing
  become: yes
  become_user: "{{ calibre_web_user }}"
  shell: |
    if [ ! -f {{ calibre_library_path }}/metadata.db ]; then
      calibredb add --empty --with-library {{ calibre_library_path }}
    fi
  args:
    executable: /bin/bash
    creates: "{{ calibre_library_path }}/metadata.db"

- name: Install dependencies
  apt:
    name: [python3-venv, python3-pip, libgl1-mesa-glx, libegl1, libxcomposite1, wget, xz-utils]
    state: present
    update_cache: yes

- name: Install Calibre (Desktop/Server tools)
  shell: "wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sh /dev/stdin"
  args:
    creates: /usr/bin/calibre-server

- name: Create Calibre-Web directory and VENV
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ calibre_web_user }}"
  loop:
    - "/opt/calibre-web"
    - "{{ calibre_library_path }}"

- name: Install Calibre-Web in venv
  pip:
    name: calibreweb
    virtualenv: /opt/calibre-web/venv
    virtualenv_command: python3 -m venv

- name: Deploy Systemd Service
  template:
    src: calibre-web.service.j2
    dest: /etc/systemd/system/calibre-web.service
  notify: Restart Calibre-Web