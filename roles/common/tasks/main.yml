---
# ── Detect environment ──────────────────────────────────────────
- name: Check if this is a Proxmox host
  ansible.builtin.stat:
    path: /usr/bin/pvesh
  register: is_pve_host

# ── Container cleanup (remove PVE repos that lack signing keys) ─
- name: Remove Proxmox repos from containers
  ansible.builtin.shell: "rm -f /etc/apt/sources.list.d/pve-* /etc/apt/sources.list.d/ceph*"
  changed_when: false
  when: not is_pve_host.stat.exists

# ── Baseline setup (runs everywhere) ───────────────────────────
- name: Generate locale
  ansible.builtin.shell: |
    sed -i 's/^# *\(en_US.UTF-8\)/\1/' /etc/locale.gen
    locale-gen
    update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
  args:
    creates: /usr/lib/locale/locale-archive

- name: Disable IPv6
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: "1"
    sysctl_file: /etc/sysctl.d/99-disable-ipv6.conf
    reload: true
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6

- name: Install sudo and dependencies
  ansible.builtin.apt:
    name:
      - sudo
      - curl
      - git
    state: present
    update_cache: true

- name: Create ops user
  ansible.builtin.user:
    name: "{{ common_ops_user }}"
    uid: "{{ common_ops_uid }}"
    shell: "{{ common_ops_shell }}"
    groups: ["sudo"]
    append: true
    create_home: true
    state: present

- name: Set up SSH authorized key for ops
  ansible.posix.authorized_key:
    user: "{{ common_ops_user }}"
    key: "{{ ops_ssh_public_key }}"
    state: present
    exclusive: false

- name: Allow ops passwordless sudo
  ansible.builtin.copy:
    content: "{{ common_ops_user }} ALL=(ALL) NOPASSWD:ALL\n"
    dest: "/etc/sudoers.d/{{ common_ops_user }}"
    mode: "0440"
    validate: "visudo -cf %s"

- name: Harden SSH — disable root login and password auth
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
  notify: Restart SSH

- name: Create chezmoi config directory
  ansible.builtin.file:
    path: /home/{{ common_ops_user }}/.config/chezmoi
    state: directory
    owner: "{{ common_ops_user }}"
    group: "{{ common_ops_user }}"
    mode: "0755"

- name: Pre-populate chezmoi config (skip interactive prompts)
  ansible.builtin.copy:
    content: |
      [data]
          email = "{{ chezmoi_email }}"
          name = "{{ chezmoi_fullname }}"
          username = "{{ github_username }}"
          docker = false
          ephemeral = false
          headless = true
          is_server = true
          secret = false
          onepasswordAccount = ""
    dest: /home/{{ common_ops_user }}/.config/chezmoi/chezmoi.toml
    owner: "{{ common_ops_user }}"
    group: "{{ common_ops_user }}"
    mode: "0644"
    force: false

- name: Install chezmoi
  ansible.builtin.shell: |
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /home/{{ common_ops_user }}/.config/bin
  args:
    creates: /home/{{ common_ops_user }}/.config/bin/chezmoi
  become: true
  become_user: "{{ common_ops_user }}"

- name: Initialize chezmoi repo
  ansible.builtin.shell: |
    /home/{{ common_ops_user }}/.config/bin/chezmoi init bhdicaire
  args:
    creates: /home/{{ common_ops_user }}/.local/share/chezmoi
  become: true
  become_user: "{{ common_ops_user }}"

- name: Apply chezmoi dotfiles
  ansible.builtin.shell: |
    /home/{{ common_ops_user }}/.config/bin/chezmoi update --force
  become: true
  become_user: "{{ common_ops_user }}"
  changed_when: false

# ── PVE host tasks (skipped inside containers) ─────────────────
- name: Configure Proxmox host
  when: is_pve_host.stat.exists
  block:
    - name: Set system timezone
      ansible.builtin.timezone:
        name: "{{ timezone }}"

    - name: Ensure systemd-timesyncd is installed
      ansible.builtin.apt:
        name: systemd-timesyncd
        state: present

    - name: Configure NTP
      ansible.builtin.lineinfile:
        path: /etc/systemd/timesyncd.conf
        regexp: '^#?NTP='
        line: "NTP={{ ntp_server }}"
      notify: Restart Timesyncd

    - name: Remove problematic Enterprise source files
      ansible.builtin.file:
        path: "/etc/apt/sources.list.d/{{ item }}"
        state: absent
      loop: "{{ pve_enterprise_sources_to_remove }}"

    - name: Create No-Subscription source file
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-sub.sources
        content: |
          Types: deb
          URIs: http://download.proxmox.com/debian/pve
          Suites: trixie
          Components: pve-no-subscription
          Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg

    - name: Install PVE dependencies
      ansible.builtin.apt:
        update_cache: true
        name:
          - python3-proxmoxer
          - ifupdown2
          - sudo
        state: present

    - name: Safe Proxmox Upgrade
      ansible.builtin.apt:
        upgrade: dist

    - name: Disable "No valid subscription" nag
      ansible.builtin.shell:
        cmd: >-
          sed -Ezi.bak
          "s/(Ext.Msg.show\(\{\s+title: gettext\('No valid sub)/void\(\{ \/\/\1/g"
          /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
      args:
        creates: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js.bak
      notify: Restart PVEProxy

    - name: Fix stale IP in login banner
      ansible.builtin.copy:
        dest: /etc/issue
        content: |
          Welcome to the Proxmox Virtual Environment
          Please use your web browser to configure this server - connect to:
            https://{{ ansible_host }}:8006/

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '127\.0\.1\.1.*'
        line: "127.0.1.1 {{ inventory_hostname }}"

    - name: Update template catalog
      ansible.builtin.command: pveam update
      changed_when: false

    - name: Download LXC templates
      ansible.builtin.command: pveam download {{ item.storage }} {{ item.template }}
      args:
        creates: "/var/lib/vz/template/cache/{{ item.template }}"
      loop: "{{ pve_lxc_templates }}"

    - name: Download ISO images
      ansible.builtin.get_url:
        url: "{{ item.url }}"
        dest: "{{ item.dest }}"
        mode: '0644'
      loop: "{{ pve_iso_images }}"